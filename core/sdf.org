#+TITLE: SDF functions
2d Signed Distance Field (SDF), implemented in C using
the mathc library.

[[https://iquilezles.org/articles/distfunctions2d/]]
* Tangled File
#+NAME: sdf.c
#+BEGIN_SRC c :tangle core/sdf.c
#include <math.h>
#include "mathc/mathc.h"
<<funcs>>
#+END_SRC

#+NAME: sdf.h
#+BEGIN_SRC c :tangle core/sdf.h
#ifndef SK_MNOLTH_SDF_H
#define SK_MNOLTH_SDF_H
<<funcdefs>>
#endif
#+END_SRC
* Sign
#+NAME: funcdefs
#+BEGIN_SRC c
float sdf_sign(float x);
#+END_SRC

#+NAME: funcs
#+BEGIN_SRC c
float sdf_sign(float x)
{
    if (x == 0) return 0;
    return x < 0 ? -1 : 1;
}
#+END_SRC
* Min/Max
#+NAME: funcdefs
#+BEGIN_SRC c
float sdf_min(float x, float y);
float sdf_max(float x, float y);
#+END_SRC

#+NAME: funcs
#+BEGIN_SRC c
float sdf_min(float x, float y)
{
    return x < y ? x : y;
}

float sdf_max(float x, float y)
{
    return x > y ? x : y;
}
#+END_SRC
* Circle
#+NAME: funcdefs
#+BEGIN_SRC c
float sdf_circle(struct vec2 p, float r);
#+END_SRC

#+NAME: funcs
#+BEGIN_SRC c
float sdf_circle(struct vec2 p, float r)
{
    return svec2_length(p) - r;
}
#+END_SRC
* Heart
#+NAME: funcdefs
#+BEGIN_SRC c
float sdf_heart(struct vec2 p);
struct vec2 sdf_heart_center(struct vec2 pos, struct vec2 res);
#+END_SRC

#+NAME: funcs
#+BEGIN_SRC c
static float dot2(struct vec2 p)
{
    return svec2_dot(p, p);
}
float sdf_heart(struct vec2 p)
{
    p.x = fabs(p.x);
    /* p.y = 1 - p.y; */
    /* p.y = p.y - 0.5; */

    if (p.y + p.x > 1.0) {
        return sqrt(dot2(svec2_subtract(p, svec2(0.25, 0.75)))) -
            sqrt(2.0)/4.0;
    }
    return sqrt(sdf_min(dot2(svec2_subtract(p, svec2(0.0, 1.00))),
                    dot2(svec2_subtract_f(p, 0.5*sdf_max(p.x+p.y, 0.0))))) *
                    sdf_sign(p.x - p.y);
}

struct vec2 sdf_heart_center(struct vec2 pos, struct vec2 res)
{
    struct vec2 p;
    p.x = (2.0 * pos.x - res.x) / res.y;
    p.y = (2.0 * (res.y - pos.y) - res.y) / res.y;
    p.y += 0.5;
    return p;
}
#+END_SRC
* Smoothstep
#+NAME: funcdefs
#+BEGIN_SRC c
float sdf_smoothstep(float e0, float e1, float x);
#+END_SRC

#+NAME: funcs
#+BEGIN_SRC c
float sdf_smoothstep(float e0, float e1, float x)
{
    float t;
    t = clampf((x - e0) / (e1 - e0), 0.0, 1.0);
    return t * t * (3.0 - 2.0 * t);
}
#+END_SRC
* Normalize
#+NAME: funcdefs
#+BEGIN_SRC c
struct vec2 sdf_normalize(struct vec2 pos, struct vec2 res);
#+END_SRC

#+NAME: funcs
#+BEGIN_SRC c
struct vec2 sdf_normalize(struct vec2 pos, struct vec2 res)
{
    struct vec2 p;
    p = svec2_multiply_f(pos, 2.0);
    p = svec2_subtract(p, res);
    p = svec2_divide_f(p, res.y);
    return p;
}
#+END_SRC
